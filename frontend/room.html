<!DOCTYPE html>
<html>
<head>
    <title>Quiz Room</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
<h2>Join a Room</h2>
<input id="username" placeholder="Enter username" />
<input id="room" placeholder="Enter room code" />
<button onclick="joinRoom()">Join</button>

<h3>Users in Room:</h3>
<ul id="users"></ul>
<button onclick="startQuiz()">Start Quiz (Admin only)</button>
<p id="timer">Time Left: <span id="time">15</span>s</p>

<div id="quiz">
    <h2 id="questionText"></h2>
    <div id="options"></div>
</div>
<div id="leaderboard">
    <h3>üèÜ Live Leaderboard</h3>
    <ul id="leaderboardList"></ul>
</div>


<h3 id="result"></h3>


<script>
    const socket = io("http://localhost:5000");
    const userMap = {}; // socketId => username

    function joinRoom() {
        const username = document.getElementById('username').value;
        const room = document.getElementById('room').value;
        socket.emit('join_room', { username, room });
    }

    socket.on('room_users', (users) => {
        const ul = document.getElementById('users');
        ul.innerHTML = '';

        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user.username;
            ul.appendChild(li);

            // Store for leaderboard mapping
            userMap[user.socketId] = user.username;
        });
    });

    function startQuiz() {
        const room = document.getElementById('room').value;
        console.log("Starting quiz in room:", room); // ‚úÖ Debug log
        socket.emit('start_quiz', room);
    }

    let countdownInterval; // global to clear between questions

    socket.on('new_question', (data) => {
        document.getElementById('questionText').textContent = data.question;

        const opts = document.getElementById('options');
        opts.innerHTML = '';

        data.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.onclick = () => {
                socket.emit('submit_answer', {
                    answer: opt,
                    index: data.index,
                    room: document.getElementById('room').value
                });

                // Disable all buttons after answering
                Array.from(opts.children).forEach(b => b.disabled = true);
            };
            opts.appendChild(btn);
        });

        // TIMER STARTS HERE
        clearInterval(countdownInterval); // clear any previous timer
        let timeLeft = 15;
        const timerDisplay = document.getElementById('time');
        timerDisplay.textContent = timeLeft;

        countdownInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                opts.innerHTML = '<p>‚è∞ Time\'s up!</p>';
            }
        }, 1000);
    });


    socket.on('quiz_ended', (scores) => {
        const score = scores[socket.id] || 0;
        document.getElementById('result').textContent = `Quiz Ended! Your Score: ${score}`;
    });
    socket.on('update_leaderboard', (scores) => {
        const list = document.getElementById('leaderboardList');
        list.innerHTML = '';

        // Convert to array and sort descending by score
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);

        sorted.forEach(([socketId, score]) => {
            const name = userMap[socketId] || 'Anonymous';
            const li = document.createElement('li');
            li.textContent = `${name}: ${score}`;
            list.appendChild(li);
        });
    });


</script>
</body>
</html>
