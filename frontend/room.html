<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz Room</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <!-- Bootstrap -->
    <link
            rel="stylesheet"
            href="assets/dist/framework/bootstrap/css/bootstrap.min.css"
    />
    <!-- Theme Files -->
    <link rel="stylesheet" href="assets/dist/theme/css/color.css" />
    <link rel="stylesheet" href="assets/dist/theme/css/theme.css" />
    <link rel="stylesheet" href="assets/dist/theme/css/responsive.css" />
    <link rel="stylesheet" href="assets/dist/theme/css/animation.css" />
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4 font-sans">

<script>
    if (!localStorage.getItem("token")) {
        window.location.href = "login.html";
    }
</script>

<div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">üéì Real-Time Quiz Room</h1>

    <!-- Join Inputs -->
    <div class="flex gap-2 justify-center mb-6">
        <input id="username" type="text" placeholder="Enter username" class="border p-2 rounded w-1/3" />
        <input id="room" type="text" placeholder="Enter room code" class="border p-2 rounded w-1/3" />
        <button id="joinBtn" onclick="joinRoom()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Join</button>
    </div>

    <!-- Room Users -->
    <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="text-xl font-semibold mb-2">üë• Users in Room:</h2>
        <ul id="users" class="list-disc list-inside text-gray-700"></ul>
    </div>

    <!-- Start Quiz -->
    <div class="flex justify-center mb-4">
        <button onclick="startQuiz()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Start Quiz (Admin only)</button>
    </div>

    <!-- Leaderboard -->
    <div class="text-center">
        <a href="dashboard.html" class="btn btn-primary btn-lg">
            Dashboard
        </a>
        <div class="mt-4 text-center">
            <button onclick="window.location.href='create-quiz.html'" class="btn btn-primary">
                ‚ûï Create New Quiz
            </button>
        </div>
    </div>

    <!-- Final Result -->
    <h3 id="result" class="text-center text-xl font-semibold text-green-600"></h3>
</div>

<script>
    lucide.createIcons();

    const token = localStorage.getItem("token");
    const savedUsername = localStorage.getItem("username");
    const savedRoom = localStorage.getItem("room");

    const socket = io("http://localhost:5000", { auth: { token } });

    const userMap = {};
    let mySocketId = null;

    const usernameInput = document.getElementById("username");
    const roomInput = document.getElementById("room");
    const joinBtn = document.getElementById("joinBtn");

    if (savedUsername) usernameInput.value = savedUsername;
    if (savedRoom) roomInput.value = savedRoom;

    socket.on("connect", () => {
        mySocketId = socket.id;
        console.log("‚úÖ Connected with ID:", mySocketId);
    });

    function joinRoom() {
        const username = usernameInput.value.trim();
        const room = roomInput.value.trim();

        if (!username || !room) {
            alert("Please enter both username and room!");
            return;
        }

        localStorage.setItem("username", username);
        localStorage.setItem("room", room);

        socket.emit("join_room", { username, room, token });

        usernameInput.disabled = true;
        roomInput.disabled = true;
        joinBtn.disabled = true;
        joinBtn.textContent = "Joined";
    }

    function startQuiz() {
        const room = localStorage.getItem("room");
        if (!room) {
            alert("Room not found in localStorage");
            return;
        }
        console.log("üì® Emitting start_quiz for room:", room); // ‚úÖ Add this line
        socket.emit("start_quiz", room);
    }


    socket.on("redirect_to_quiz", () => {
        console.log("‚úÖ redirect_to_quiz event received");
        alert("Quiz is starting! Redirecting...");
        window.location.href = "question.html";
    });


    socket.on("room_users", (users) => {
        const ul = document.getElementById("users");
        ul.innerHTML = "";
        users.forEach(user => {
            const li = document.createElement("li");
            const isYou = user.socketId === socket.id;
            li.textContent = isYou ? "You" : user.username;
            ul.appendChild(li);
            userMap[user.socketId] = user.username;
        });
    });


    socket.on("update_leaderboard", (scores) => {
        const list = document.getElementById("leaderboardList");
        list.innerHTML = "";

        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        sorted.forEach(([socketId, score]) => {
            const name = userMap[socketId] || "Player";
            const isYou = socketId === socket.id;
            const li = document.createElement("li");
            li.innerHTML = `<span class="font-semibold">${isYou ? "You" : name}</span>: ${score}`;
            list.appendChild(li);
        });
    });

    socket.on("quiz_ended", (scores) => {
        const score = scores?.score || scores?.[socket.id] || 0;
        document.getElementById("result").textContent = `üéâ Quiz Ended! Your Score: ${score}`;
    });

    socket.on("error", (msg) => {
        alert("‚ùå Error: " + msg);
    });
</script>

</body>
</html>
